<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, minimal-ui">
  <title>iptables-diff</title>
  <script src="bower_components/cytoscape/dist/cytoscape.js"></script>
  <style id="css">
    body {
      font: 14px helvetica neue, helvetica, arial, sans-serif;
    }
    #cy {
      height: 100%;
      width: 100%;
      position: absolute;
      left: 0;
      top: 0;
    }
    #info {
      color: #c88;
      font-size: 1em;
      position: absolute;
      z-index: -1;
      left: 1em;
      top: 1em;
    }
  </style>
</head>
<body>

<div id="cy"></div>

<script>

function httpGetAsync(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); // true for asynchronous
    xmlHttp.send(null);
}

var cy = cytoscape({
  container: document.querySelector('#cy'),

  boxSelectionEnabled: false,
  autounselectify: true,

  style: cytoscape.stylesheet()
    .selector('node')
      .css({
        'shape': 'rectangle',
        'content': 'data(name)',
        'text-valign': 'center',
        'color': 'white',
        'text-outline-width': 0,
        'background-color': '#999',
        'text-outline-color': '#999',
        'width': 'label',
        'padding': 2
      })
    .selector('edge')
      .css({
        'curve-style': 'bezier',
        'target-arrow-shape': 'triangle',
        'target-arrow-color': '#ccc',
        'line-color': '#ccc',
        'width': 1
      })
    .selector(':selected')
      .css({
        'background-color': 'black',
        'line-color': 'black',
        'target-arrow-color': 'black',
        'source-arrow-color': 'black'
      })
    .selector('.faded')
      .css({
        'opacity': 0.25,
        'text-opacity': 0
      }),

  layout: {
    name: 'grid',
    padding: 10
  }
});

cy.on('tap', 'node', function(e){
  var node = e.cyTarget;
  var neighborhood = node.neighborhood().add(node);

  cy.elements().addClass('faded');
  neighborhood.removeClass('faded');
});

cy.on('tap', function(e){
  if( e.cyTarget === cy ){
    cy.elements().removeClass('faded');
  }
});

httpGetAsync("/iptables", function(ipt) {
  var ipt = JSON.parse(ipt);

  var elements = [];
  var curr_y = 0;

  Object.keys(ipt.tables).forEach(function(tableName) {
    var tableUID = ipt.tables[tableName].uid;

    elements.push({
        group: "nodes",
        data: { id: tableUID, name: tableName },
        position: { x: 0, y: curr_y }
    });

    Object.keys(ipt.tables[tableName].chains).forEach(function(chainName) {
      var chain = ipt.tables[tableName].chains[chainName];
      var chainUID = chain.uid

      elements.push({
          group: "nodes",
          data: { id: chainUID, name: chainName, faveShape: 'triangle' },
          position: { x: 300, y: curr_y }
      });
      elements.push({ data: { source: tableUID, target: chainUID } });

      var prevUID = chain.uid;
      var curr_x = 600;
      chain.rules.forEach(function(rule) {
        elements.push({
            group: "nodes",
            data: { id: rule.uid, name: rule.args + " -j " + rule.target },
            position: { x: curr_x, y: curr_y }
        });
        elements.push({ data: { source: prevUID, target: rule.uid } });
        prevUID = rule.uid;
        curr_x += 300;
      });

      curr_y += 100;

    });

    curr_y += 100;

  });

  cy.add(elements);
});

</script>

</body>
</html>
