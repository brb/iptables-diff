<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>iptables-diff</title>

  <script src="bower_components/d3/d3.js"></script>
  <script src="bower_components/lodash/lodash.js"></script>
  <script src="bower_components/graphlib/dist/graphlib.core.js"></script>
  <script src="bower_components/dagre/dist/dagre.core.js"></script>
  <script src="bower_components/dagre-d3/dist/dagre-d3.core.js"></script>
  <style id="css">
  text {
    font-weight: 300;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
    font-size: 14px;
  }

  .node rect {
    stroke: #333;
    fill: #fff;
    stroke-width: 1.5px;
  }

  .edgePath path.path {
    stroke: #333;
    fill: none;
    stroke-width: 1.5px;
  }

  .arrowhead {
   stroke: blue;
   fill: blue;
   stroke-width: 1.5px;
  }
</style>

</head>
<body>

<svg width="2000" height="2000"></svg>

<script>

function httpGetAsync(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); // true for asynchronous
    xmlHttp.send(null);
}

var g = new dagreD3.graphlib.Graph().setGraph({rankdir: "LR"});
var render = new dagreD3.render();

httpGetAsync("/iptables", function(ipt) {
  var ipt = JSON.parse(ipt);

  Object.keys(ipt.tables).forEach(function(tableName) {
    var tableUID = ipt.tables[tableName].uid;
    g.setNode(tableUID, { label: tableName, style: "fill: #afa" });

    Object.keys(ipt.tables[tableName].chains).forEach(function(chainName) {
      var chain = ipt.tables[tableName].chains[chainName];
      var chainUID = chain.uid
      g.setNode(chainUID, {label: chainName,  rx: 5, ry: 5 });
      g.setEdge(tableUID, chainUID, {});

      chain.rules.forEach(function(rule) {
        g.setNode(rule.uid, {label: rule.args + " -j " + rule.target, rx: 5, ry: 5 });
        g.setEdge(chainUID, rule.uid, {});
      });
    });
  });


  // Set up an SVG group so that we can translate the final graph.
  var svg = d3.select("svg"),
      inner = svg.append("g");

  // Set up zoom support
  var zoom = d3.zoom()
      .on("zoom", function() {
        inner.attr("transform", d3.event.transform);
      });
  svg.call(zoom);

  // Simple function to style the tooltip for the given node.
  var styleTooltip = function(name, description) {
    return "<p class='name'>" + name + "</p><p class='description'>" + description + "</p>";
  };

  // Run the renderer. This is what draws the final graph.
  render(inner, g);

  // Center the graph
  var initialScale = 0.75;
  svg.call(zoom.transform, d3.zoomIdentity.translate((svg.attr("width") - g.graph().width * initialScale) / 2, 20).scale(initialScale));

  svg.attr('height', g.graph().height * initialScale + 40);
});

</script>

</body>
</html>
